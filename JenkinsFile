pipeline {
    agent any
    environment {
        frontendImage='rushikesh0203/virtuallab_frontend'
        backendImage='rushikesh0203/virtuallab_backend'
        dbImage='rushikesh0203/virtuallab_db'
        dockerfrontendImage = ''
        dockerbackendImage = ''
        dockerdbImage = ''
   }
    stages {
        stage('Git Checkout') {
            steps {
                script{
                    git 'https://github.com/vinayakchaturvedi/VirtualLab'
                }
            }
        }
        stage('Unit Test') {
            steps {
                script{

                    sh 'mvn clean test '
                }
            }
        }
        stage('Build executable jar') {
            steps {
                script{
                    sh 'mvn -Dmaven.test.skip=true package'
                }
            }
        }
        stage('Build npm modules') {
            steps {
                script{
                    sh 'npm clean-install --prefix ./src/main/webapp/virtual-lab-ui'
                }
            }
        }
        stage('Building Backend Image') {
          steps{
            script {
              dockerbackendImage = docker.build "$backendImage"
            }
          }
        }

        stage('Building Frontend Image') {
          steps{
            script {
              dockerfrontendImage = docker.build ("$frontendImage","-f src/main/webapp/virtual-lab-ui/Dockerfile .")

            }
          }
        }

        stage('Building DB Image') {
          steps{
            script {
              dockerdbImage = docker.build ("$dbImage","-f dbDocker/Dockerfile .")
            }
          }
        }

        stage('Deploy Image') {
          steps{
            script {
              docker.withRegistry( '', 'Docker' ) {
                    dockerfrontendImage.push("${env.BUILD_NUMBER}")
                    dockerfrontendImage.push("latest")
                    dockerbackendImage.push("${env.BUILD_NUMBER}")
                    dockerbackendImage.push("latest")
                    dockerdbImage.push("${env.BUILD_NUMBER}")
                    dockerdbImage.push("latest")
              }
            }
          }
        }

        stage('Remove Unused docker image') {
          steps{
            script{
            sh "docker rmi $frontendImage:latest;docker rmi $frontendImage:${env.BUILD_NUMBER}";
            sh "docker rmi $backendImage:latest;docker rmi $backendImage:${env.BUILD_NUMBER}";
            sh "docker rmi $dbImage:latest;docker rmi $dbImage:${env.BUILD_NUMBER}";
          }
          }
        }
    }
}